variables:
  CDP_DEFINITION_BUILD_COUNT: $[counter('', 0)] # needed for onebranch.pipeline.version task https://aka.ms/obpipelines/versioning
  WindowsContainerImage: "cdpxwin1809.azurecr.io/global/obinfra/windows/1809/vs2019:latest"

resources:
  repositories:
    - repository: templates
      type: git
      name: OneBranch.Pipelines/GovernedTemplates
      ref: refs/heads/main

extends:
  template: v2/OneBranch.NonOfficial.CBWorkflow.yml@templates # https://aka.ms/obpipelines/templates
  parameters:
    stages:
      - stage: build
        jobs:
          - job: main
            pool:
              type: windows
            variables:
              ob_outputDirectory: '$(Build.SourcesDirectory)\output'
            steps:
              - task: onebranch.pipeline.version@1
                inputs:
                  system: "RevisionCounter"
                  major: "1"
                  minor: "3"
                  ${{ if ne(variables['Build.SourceBranch'], 'refs/heads/master') }}:
                    tag: official
              - task: npmAuthenticate@0
                inputs:
                  workingFile: 'src\\.npmrc'
              - task: CmdLine@2
                displayName: 'NPM Install'
                inputs:
                  script: '$(Build.SourcesDirectory)\npmInstall.cmd'
                  workingDirectory: '$(Build.SourcesDirectory)'
              
              - task: CmdLine@2
                displayName: 'NPM Install scripts'
                inputs:
                  script: '$(Build.SourcesDirectory)\scripts\npmInstall.cmd'
                  workingDirectory: '$(Build.SourcesDirectory)'
                  
              - task: CmdLine@2
                displayName: 'Get Localized Repos'
                inputs:
                  script: '$(Build.SourcesDirectory)\scripts\restoreDocs.cmd'
                  workingDirectory: '$(Build.SourcesDirectory)'
              
              - task: CmdLine@2
                displayName: 'Restore Loc'
                inputs:
                  script: '$(Build.SourcesDirectory)\scripts\restoreLoc.cmd'
                  workingDirectory: '$(Build.SourcesDirectory)'